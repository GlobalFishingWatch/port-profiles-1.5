---
title: "Recent port activity of Port Program pilot countries"
author: "Max Schofield"
date: "2023-11-14"
output:
  html_document:
    df_print: paged
  df_print: default
  html_notebook: null
highlight: pygments
toc: yes
toc_float:
  toc_collapsed: yes
toc_depth: 2
editor_options:
  chunk_output_type: inline
---

```{=html}
<style>
body {
text-align: left}
</style>
```

# Setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, echo=F, warning=F, include=FALSE}
load_or_install_libraries <- function(x){
  for( i in x ){
    #  require returns TRUE invisibly if it was able to load package
    if( ! require( i , character.only = TRUE ) ){
      #  If package was not able to be loaded then re-install
      install.packages( i , dependencies = TRUE )
      #  Load package after installing
      require( i , character.only = TRUE )
    }
  }
}

#  Then try/install packages...
load_or_install_libraries( c("tidyverse" , "bigrquery" ,"devtools", "DBI","glue", "lubridate", "here", "sf", "extrafont", "patchwork", "terra", "rgeos", "ggspatial") )

# get fishwatch r independently 
if (!require("fishwatchr")) {devtools::install_github("GlobalFishingWatch/fishwatchr")}
library(fishwatchr)

# if (!require("extrafont"))
#   install.packages("extrafont")

# # Unfortunately `extrafont::font_import()` will fail on latest Rttf2pt1 package...
# # so we need to install old version
# devtools::install_version("Rttf2pt1", version = "1.3.8")
# 
# # Import fonts to R
# # This will take few minutes
# extrafont::font_import()

# remove a package causing issues 
#detach("package:plyr", unload=TRUE)
```

```{r connection to BQ, echo=F, warning=F, include=FALSE}
con <- DBI::dbConnect(drv = bigrquery::bigquery(), 
                      project = "world-fishing-827", 
                      use_legacy_sql = FALSE)
```

# Dakar 

```{r set date and port parameters, echo=F, warning=F, include=FALSE}
start_date <- "'2024-01-01 00:00:00 UTC'" 
end_date <- "'2024-03-31 23:59:59 UTC'"
year <- 2024
country_iso3 <- "'SEN'"
port_name <- "'DAKAR'"

# file names
month <- 'Q1'
country <- 'SEN'

```

```{r voyages all, echo=F, warning=F, include=FALSE}

voyages_q <- readr::read_file(here::here("queries","proactive", "recent_port_activity_c2_v3.sql"))

voyages <- fishwatchr::gfw_query(query = glue::glue(voyages_q, 
                                                    start_date = start_date,
                                                    end_date = end_date,
                                                    year = year,
                                                    port_label = port_name,
                                                    port_iso = country_iso3),
                                 run_query = TRUE,
                                 con = con)$data



```

```{r groom data to TMT format}
dak_voyages <- dplyr::select(voyages, vessel_name=shipname, MMSI=ssvid,
   Flag=vessel_flag_best, vessel_class=vessel_class_best,
   vessel_type=geartype_best,  previous_port_country = start_port_iso3,
   previous_port = start_port_label, trip_start, trip_start_confidence, trip_end, trip_end_confidence, trip_duration_days,
   end_port = end_port_label, fishing=num_fishing, fishing_hours, fishing_eez=eezs, fishing_hs =high_seas, fishing_rfmos = rfmos, encounter= 1, num_encounters=num_encounters, loitering=1, num_loitering, vessel_id=vessel_id, trip_id=trip_id)
   #gaps=1, num_gaps, total_gap_hours)

# overwrite encounters T/F
dak_voyages$encounter <- ifelse(is.na(dak_voyages$num_encounters), FALSE, TRUE)

# overwrite fishing T/F
dak_voyages$loitering <- ifelse(is.na(dak_voyages$num_loitering), FALSE, TRUE)

# overwrite loitering T/F
dak_voyages$fishing <- ifelse(is.na(dak_voyages$fishing), FALSE, TRUE)

# overwrite loitering T/F
#dak_voyages$gaps <- ifelse(is.na(dak_voyages$num_gaps), FALSE, TRUE)

dak_voyages$fishing_hs <- ifelse(is.na(dak_voyages$fishing_hs), FALSE, TRUE)

```


```{r voyages extra as queries cant link up, echo=F, warning=F, include=FALSE}

extra <- fishwatchr::gfw_query(query = c("SELECT * FROM `world-fishing-827.scratch_max.aiscoverage_dakar_2024-q1_pipe25`"),
                                 run_query = TRUE,
                                 con = con)$data
```
```{r final r manipulation}

full_dak_info <- left_join(dak_voyages, dplyr::select(extra,vessel_id, trip_id, at_dock, percent_ais_voyage), by=c('vessel_id','trip_id'))

write.csv(dplyr::select(full_dak_info,-vessel_id, -trip_id), here::here("data", "dakar_Q1_2024_01May2024.csv"), row.names=F)
```


```{r pull in TMT data make figures}
tmt_review <- read.csv(here::here("data","proactive", "dakar_Q1_2024_19Apr2024_tmt_review.csv"), header=T)

# drop rows which TMT identified to be removed 
tmt_review$Remove.or.check[tmt_review$Remove.or.check==""] <- NA
tmt_review$Remove.or.check[grepl("^Remove", tmt_review$Remove.or.check)] <- 'Remove'
tmt_review$Remove.or.check[grepl("^Check", tmt_review$Remove.or.check)] <- 'Check'

tmt_review_v2 <- filter(tmt_review, Remove.or.check != 'Remove' | is.na(Remove.or.check))

#### correct vessel type #### 
tmt_review_v2$Incorrect...missing.vessel.type[tmt_review_v2$Incorrect...missing.vessel.type==""] <- NA

# set names for vessel type to same levels existing 
table(tmt_review_v2$Incorrect...missing.vessel.type)
tmt_review_v2$Incorrect...missing.vessel.type[tmt_review_v2$Incorrect...missing.vessel.type=='Fishing vessel'] <- 'fishing'
tmt_review_v2$Incorrect...missing.vessel.type[tmt_review_v2$Incorrect...missing.vessel.type=='Reefer'] <- 'carrier'
tmt_review_v2$Incorrect...missing.vessel.type[tmt_review_v2$Incorrect...missing.vessel.type=='Support vessel'] <- 'support'
table(tmt_review_v2$Incorrect...missing.vessel.type)

tmt_review_v2$vessel_class[!is.na(tmt_review_v2$Incorrect...missing.vessel.type)] <- tmt_review_v2$Incorrect...missing.vessel.type[!is.na(tmt_review_v2$Incorrect...missing.vessel.type)] 

table(tmt_review_v2$vessel_class)
# still some seismic_vessels to correct with missing data from TMT 
tmt_review_v2$vessel_class[tmt_review_v2$vessel_class=='seismic_vessel'] <- 'fishing'
tmt_review_v2$vessel_class[tmt_review_v2$vessel_class=='other'] <- 'fishing'
table(tmt_review_v2$vessel_class)

####----------------------------------------------------------------------------
#### correct vessel class #### 
tmt_review_v2$Incorrect...missing.gear[tmt_review_v2$Incorrect...missing.gear==""] <- NA
# set names for vessel type to same levels existing 
table(tmt_review_v2$Incorrect...missing.gear)
tmt_review_v2$Incorrect...missing.gear[tmt_review_v2$Incorrect...missing.gear=='Longline'] <- 'fishing'
tmt_review_v2$Incorrect...missing.gear[tmt_review_v2$Incorrect...missing.gear=='Pole and line'] <- 'pole_and_line'
tmt_review_v2$Incorrect...missing.gear[tmt_review_v2$Incorrect...missing.gear=='Trawler '] <- 'trawlers'
tmt_review_v2$Incorrect...missing.gear[tmt_review_v2$Incorrect...missing.gear=='Trawler'] <- 'trawlers'
tmt_review_v2$Incorrect...missing.gear[tmt_review_v2$Incorrect...missing.gear=='Purse seine'] <- 'tuna_purse_seines'
tmt_review_v2$Incorrect...missing.gear[tmt_review_v2$Incorrect...missing.gear=='Longline'] <- 'longliners'
table(tmt_review_v2$Incorrect...missing.gear)


tmt_review_v2$vessel_type[!is.na(tmt_review_v2$Incorrect...missing.gear)] <- tmt_review_v2$Incorrect...missing.gear[!is.na(tmt_review_v2$Incorrect...missing.gear)]
table(tmt_review_v2$vessel_type)

# still some manual grooming 
tmt_review_v2$vessel_type[tmt_review_v2$vessel_type=='other'] <- 'fishing'

# set to vessel class when inconclusive
tmt_review_v2$vessel_type[tmt_review_v2$vessel_type=='inconclusive'] <- tmt_review_v2$vessel_class
table(tmt_review_v2$vessel_type)

#####---------------------------------------------------------------------------
#### correct Flag #### 
tmt_review_v2$Incorrect...missing.flag[tmt_review_v2$Incorrect...missing.flag==""] <- NA
tmt_review_v2$Flag[!is.na(tmt_review_v2$Incorrect...missing.flag)] <- tmt_review_v2$Incorrect...missing.flag[!is.na(tmt_review_v2$Incorrect...missing.flag)]
table(tmt_review_v2$Flag)

```

## Figures 
```{r flag figure for Dakar}
tmt_review_v2 %>%
  group_by(Flag) %>%
  summarize(vessels = n()) %>%
  plot_donut_chart(group_var = Flag,
                   value_var = vessels,
                   donut_title = 'Dakar voyages by\nflag',
                   add_labels = T,
                   show_legend = F,
                   label_frac = 0.025,
                   show_caption = T) 

ggsave( filename = here::here('outputs', 'figures', 'q1_24_proactive', paste0(country,"_", month,"_", "dakar_fishing_flags_",str_replace_all(Sys.Date(), '-','_'),".png")), 
       units = 'cm', 
       width = 10, 
       height = 10,
       bg = '#f7f7f7')

```

```{r type figure for Dakar}
tmt_review_v2 %>%
  group_by(vessel_class) %>%
  summarize(vessels = n()) %>%
  plot_donut_chart(group_var = vessel_class,
                   value_var = vessels,
                   donut_title = 'Dakar voyages by\nclass',
                   add_labels = T,
                   show_legend = F,
                   label_frac = 0.05,
                   show_caption = T) 

ggsave( filename = here::here('outputs', 'figures', 'q1_24_proactive', paste0(country,"_", month,"_", "vessel_class_",str_replace_all(Sys.Date(), '-','_'),".png")), 
       units = 'cm', 
       width = 5, 
       height = 5,
       bg = '#f7f7f7')

```


```{r gear figure for Dakar}
tmt_review_v2 %>%
  group_by(vessel_type) %>%
  summarize(vessels = n()) %>%
  plot_donut_chart(group_var = vessel_type,
                   value_var = vessels,
                   donut_title = 'Dakar voyages by\ngear',
                   add_labels = T,
                   show_legend = F,
                   label_frac = 0.05,
                   show_caption = T) 

ggsave( filename = here::here('outputs', 'figures', 'q1_24_proactive', paste0(country,"_", month,"_", "fishing_gears_",str_replace_all(Sys.Date(), '-','_'),".png")), 
       units = 'cm', 
       width = 10, 
       height = 10,
       bg = '#f7f7f7')

```


```{r pull in the fishing data, echo=F, warning=F, include=FALSE}

q_confidence <- readr::read_file(here::here("queries","proactive", "proactive_fishing_locations.sql"))

fishing <- fishwatchr::gfw_query(query = glue::glue(q_confidence,
                                               voyages_table = "`world-fishing-827.scratch_max.voyages_dakar_q1_2024_pipe25`" 
                                               # min_date = "'2022-01-01'", 
                                               # max_date = "'2023-01-01'",
                                               ),
                                 run_query = TRUE,
                                 con = con)$data
```

```{r voyage activity longline maps, echo=F, warning=F, include=FALSE}
# sense check the data 
fishing %>%
    group_by(ssvid) %>%
      summarise(positions = n(), 
                min_date = min(event_start), 
                max_date = max(event_end))

# add gear from TMT review 
gear <- distinct(dplyr::select(tmt_review_v2, MMSI, Flag, vessel_type)) %>% 
  mutate(ssvid=as.character(MMSI))

fishing_data <- left_join(fishing, gear, by = join_by(ssvid))

# bin the data
fishing_data$lat_bin <- round(fishing_data$lat_mean/0.5)*0.5
fishing_data$lon_bin <- round(fishing_data$lon_mean/0.5)*0.5

table(fishing_data$vessel_type)

# count positions in each lat lon bin
longline_raster <- 
  # filter out low speeds while vessel in port 
  filter(fishing_data, vessel_type %in% c('drifting_longlines','set_longlines')) %>%
    group_by(lat_bin, lon_bin) %>%
      summarise(
        fishing_hours = sum(fishing_hours),
        vessels = n_distinct(ssvid)
      )

# set upper limit
up_lim <- 500 
#set plot center 
new_center <- 40

# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=40 +wktext"

# set plot limits bound on the data
bounding_atl <- transform_box(xlim = c(-60, 0),
                          ylim = c(30, -15),
                          output_crs = best_proj)

# map for atlantic longline 
atl_full <- longline_raster %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'fishing_hours',
                  center = new_center) %>% 
  ggplot()+
  geom_gfw_outline(center = new_center, theme = "dark") +
  geom_raster(aes(x= lon_bin, y=lat_bin, fill = fishing_hours)) +
    geom_gfw_eez(theme = 'dark', alpha = 0.9, center = new_center) +
    geom_gfw_land(theme = 'dark', center = new_center) +
    # geom_sf(pipa, fill=NA, colour='green')+
    scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                      # limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +   
    coord_sf(xlim = c(bounding_atl$box_out[['xmin']], bounding_atl$box_out[['xmax']]),
      ylim = c(bounding_atl$box_out[['ymin']], bounding_atl$box_out[['ymax']]),
      crs = bounding_atl$out_crs) +
    # scale_x_continuous(breaks = custom_breaks, labels = custom_labels)+
    labs(fill = 'Fishing Hours') +
    theme_gfw_map(theme = 'light') +
    theme(legend.text = element_text(family = 'Roboto',
                                 color = '#848b9b',
                                 size = 6),
        legend.title = element_text(family = 'Roboto',
                                  face = 'bold',
                                  color = '#363c4c',
                                  size = 6),
      legend.position = 'bottom',
      legend.box = 'vertical',
      legend.key.height = unit(2, 'mm'),
      legend.key.width = unit(15,'mm'))


fishwatchr::add_little_globe(atl_full,
                             main_box = bounding_atl,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperright')

ggsave(filename = here::here('outputs', 'figures','q1_24_proactive', paste0(country,"_", month,"_", "longline_map_",str_replace_all(Sys.Date(), '-','_'),".png")), 
       units = 'cm', 
       width = 15, 
       height = 17,
       bg = '#f7f7f7')

```


```{r voyage activity trawl maps, echo=F, warning=F, include=FALSE}
# add a different lat lon bin 
fishing_data$lat_bin <- round(fishing_data$lat_mean/0.1)*0.1
fishing_data$lon_bin <- round(fishing_data$lon_mean/0.1)*0.1


# count positions in each lat lon bin
trawl_raster <- 
  # filter out low speeds while vessel in port 
  filter(fishing_data, vessel_type %in% c('trawlers')) %>%
    group_by(lat_bin, lon_bin) %>%
      summarise(
        fishing_hours = sum(fishing_hours),
        vessels = n_distinct(ssvid)
      )

# set upper limit
up_lim <- 9000 
#set plot center 
new_center <- 17

# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=17 +wktext"

# set plot limits bound on the data
bounding_wa <- transform_box(xlim = c(-20, -14),
                          ylim = c(16, 8.5),
                          output_crs = best_proj)

# trawl map 
trawl_full <- trawl_raster %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'fishing_hours',
                  center = new_center) %>% 
  ggplot()+
  geom_gfw_outline(center = new_center, theme = "dark") +
  geom_raster(aes(x= lon_bin, y=lat_bin, fill = fishing_hours)) +
    geom_gfw_eez(theme = 'dark', alpha = 0.9, center = new_center) +
    geom_gfw_land(theme = 'dark', center = new_center) +
    scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                       limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +   
    coord_sf(xlim = c(bounding_wa$box_out[['xmin']], bounding_wa$box_out[['xmax']]),
      ylim = c(bounding_wa$box_out[['ymin']], bounding_wa$box_out[['ymax']]),
      crs = bounding_wa$out_crs) +
    labs(fill = 'Fishing Hours') +
    theme_gfw_map(theme = 'light')  +
    theme(legend.text = element_text(family = 'Roboto',
                                 color = '#848b9b',
                                 size = 6),
        legend.title = element_text(family = 'Roboto',
                                  face = 'bold',
                                  color = '#363c4c',
                                  size = 6),
      legend.position = 'bottom',
      legend.box = 'vertical',
      legend.key.height = unit(2, 'mm'),
      legend.key.width = unit(15,'mm'))


fishwatchr::add_little_globe(trawl_full,
                             main_box = bounding_wa,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperright')

ggsave(filename = here::here('outputs', 'figures', paste0(country,"_", month,"_", "trawl_map_",str_replace_all(Sys.Date(), '-','_'),".png")), 
       units = 'cm', 
       width = 15, 
       height = 17,
       bg = '#f7f7f7')

```


# Ghana 


```{r set date and port GHA parameters, echo=F, warning=F, include=FALSE}
start_date <- "'2024-01-01 00:00:00 UTC'" 
end_date <- "'2024-03-31 23:59:59 UTC'"
year <- 2024
country_iso3 <- "'GHA'"
port_name <- "'TEMA'"
q_confidence <- readr::read_file(file = here::here("queries", "op_fcwc_july_23", "q_fishing_vessels_confidence_fcwc_july_2023.sql"))

fv <- fishwatchr::gfw_query(query = glue::glue(q_confidence,
                                               aoi = "`world-fishing-827.scratch_max.fcwc_gha_civ_eez_20nm_buffer`", 
                                               min_date = "'2022-01-01'", 
                                               max_date = "'2023-01-01'", 
                                               year = 2022),
                                 run_query = TRUE,
                                 con = con)$data
```

```{r voyages all, echo=F, warning=F, include=FALSE}
tem_voyages <- fishwatchr::gfw_query(query = glue::glue(voyages_q, 
                                                    start_date = start_date,
                                                    end_date = end_date,
                                                    year = year,
                                                    port_label = port_name,
                                                    port_iso = country_iso3),
                                 run_query = TRUE,
                                 con = con)$data
```

```{r groom data to TMT format}
gha_voyages <- dplyr::select(tem_voyages, vessel_name=shipname, MMSI=ssvid,
   Flag=vessel_flag_best, vessel_class=vessel_class_best,
   vessel_type=geartype_best,  previous_port_country = start_port_iso3,
   previous_port = start_port_label, trip_start, trip_start_confidence, trip_end, trip_end_confidence, trip_duration_days,
   end_port = end_port_label, fishing=num_fishing, fishing_hours, fishing_eez=eezs, fishing_hs =high_seas, fishing_rfmos = rfmos, encounter= 1, num_encounters=num_encounters, loitering=1, num_loitering, vessel_id=vessel_id, trip_id=trip_id)
   #gaps=1, num_gaps, total_gap_hours)

# overwrite encounters T/F
gha_voyages$encounter <- ifelse(is.na(gha_voyages$num_encounters), FALSE, TRUE)

# overwrite fishing T/F
gha_voyages$loitering <- ifelse(is.na(gha_voyages$num_loitering), FALSE, TRUE)

# overwrite loitering T/F
gha_voyages$fishing <- ifelse(is.na(gha_voyages$fishing), FALSE, TRUE)

# overwrite high_sea T/F
gha_voyages$fishing_hs <- ifelse(is.na(gha_voyages$fishing_hs), FALSE, TRUE)

```


```{r voyages extra ais queries gha can't link up, echo=F, warning=F, include=FALSE}

extra_gha <- fishwatchr::gfw_query(query = c("SELECT * FROM `world-fishing-827.scratch_max.aiscoverage_tema_2024-q1_pipe25`"),
                                 run_query = TRUE,
                                 con = con)$data
```

```{r final r manipulation}

full_tem_info <- left_join(gha_voyages, dplyr::select(extra_gha,vessel_id, trip_id, at_dock, percent_ais_voyage), by=c('vessel_id','trip_id'))

write.csv(dplyr::select(full_tem_info,-vessel_id, -trip_id), here::here("data", "tema_Q1_2024_19Apr2024.csv"), row.names=F)
```





























```{r carrier visits all, echo=F, warning=F, include=FALSE}

carrier_voyages_q <- readr::read_file(here::here("queries", "proactive", "recent_carrier_voyages_c2.sql"))

carrier_voyages <- fishwatchr::gfw_query(query = glue::glue(carrier_voyages_q),
                                 run_query = TRUE,
                                 con = con)$data
```

```{r fishing voyages all, echo=F, warning=F, include=FALSE}

fishing_voyages_q <- readr::read_file(here::here("queries","proactive", "recent_fishing_voyages_c2_v2.sql"))

fishing_voyages <- fishwatchr::gfw_query(query = glue::glue(fishing_voyages_q),
                                 run_query = TRUE,
                                 con = con)$data
```

```{r estabish and write out voyages data for cv & fv, echo=F, warning=F, include=FALSE}
voyages <- bind_rows(carrier_voyages, fishing_voyages)

voyages %>% 
  write_csv(here::here("data", "proactive", 
         paste0(country,"_", month ,"_voyages",str_replace_all(Sys.Date(), '-','_'),".csv")))
```

```{r basic flag statistics on voyages, echo=F, warning=F, include=FALSE}

fishing_voyages %>%
  group_by(flag) %>%
  summarize(vessels = n()) %>%
  plot_donut_chart(group_var = flag,
                   value_var = vessels,
                   donut_title = 'Fishing vessels by\nflag',
                   add_labels = T,
                   show_legend = F,
                   label_frac = 0.1,
                   show_caption = T) 

ggsave( filename = here::here('outputs', 'figures', paste0(country,"_", month,"_", "fishing_flags_",str_replace_all(Sys.Date(), '-','_'),".png")), 
       units = 'cm', 
       width = 10, 
       height = 10,
       bg = '#f7f7f7')
```

```{r basic gear statistics on voyages, echo=F, warning=F, include=FALSE}

fishing_voyages %>%
  group_by(gear) %>%
  summarize(vessels = n()) %>%
  plot_donut_chart(group_var = gear,
                   value_var = vessels,
                   donut_title = 'Fishing vessels by\ngear',
                   add_labels = T,
                   show_legend = F,
                   label_frac = 0.1,
                   show_caption = T) 

ggsave( filename = here::here('outputs', 'figures', paste0(country,"_", month,"_", "fishing_gears_",str_replace_all(Sys.Date(), '-','_'),".png")), 
       units = 'cm', 
       width = 10, 
       height = 10,
       bg = '#f7f7f7')
```


```{r voyage activity, echo=F, warning=F, include=FALSE}

fishing_voyages_activity_q <- readr::read_file(here::here("queries","proactive", "fishing_voyage_activity.sql"))

fishing_data <- fishwatchr::gfw_query(query = glue::glue(fishing_voyages_activity_q),
                                 run_query = TRUE,
                                 con = con)$data

```

```{r voyage activity longline maps, echo=F, warning=F, include=FALSE}
# sense check the data 
fishing_data %>%
    group_by(ssvid) %>%
      summarise(positions = n(), 
                min_date = min(timestamp), 
                max_date = max(timestamp))

# add fishing hours variable 
fishing_data$fishing_hours <- ifelse(fishing_data$nnet_score   > 0.5 , fishing_data$hours, 0) 
fishing_data$fishing_hours[is.na(fishing_data$fishing_hours)] <- 0

# bin the data
fishing_data$lat_bin <- round(fishing_data$lat/0.5)*0.5
fishing_data$lon_bin <- round(fishing_data$lon/0.5)*0.5

# count positions in each lat lon bin
longline_raster <- 
  # filter out low speeds while vessel in port 
  filter(fishing_data, gear %in% c('drifting_longlines','set_longlines')) %>%
    group_by(lat_bin, lon_bin) %>%
      summarise(
        hours = sum(hours),
        fishing_hours = sum(fishing_hours),
        vessels = n_distinct(ssvid)
      )

# set upper limit
up_lim <- 500 
#set plot center 
new_center <- 40

# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=40 +wktext"

# set plot limits bound on the data
bounding_atl <- transform_box(xlim = c(-60, 0),
                          ylim = c(30, -15),
                          output_crs = best_proj)

# # # Specify custom x-axis breaks and labels
# custom_breaks <- c(150, 170, -170)
# custom_labels <- c("150° E", "170° E","170° W")

atl_full <- longline_raster %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'fishing_hours',
                  center = new_center) %>% 
  ggplot()+
  geom_gfw_outline(center = new_center, theme = "dark") +
  geom_raster(aes(x= lon_bin, y=lat_bin, fill = fishing_hours)) +
    geom_gfw_eez(theme = 'dark', alpha = 0.9, center = new_center) +
    geom_gfw_land(theme = 'dark', center = new_center) +
    # geom_sf(pipa, fill=NA, colour='green')+
    scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                      # limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +   
    coord_sf(xlim = c(bounding_atl$box_out[['xmin']], bounding_atl$box_out[['xmax']]),
      ylim = c(bounding_atl$box_out[['ymin']], bounding_atl$box_out[['ymax']]),
      crs = bounding_atl$out_crs) +
    # scale_x_continuous(breaks = custom_breaks, labels = custom_labels)+
    labs(fill = 'Fishing Hours') +
    theme_gfw_map(theme = 'light') 


fishwatchr::add_little_globe(atl_full,
                             main_box = bounding_atl,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperright')

ggsave(filename = here::here('outputs', 'figures', paste0(country,"_", month,"_", "longline_map_",str_replace_all(Sys.Date(), '-','_'),".png")), 
       units = 'cm', 
       width = 20, 
       height = 20,
       bg = '#f7f7f7')

```


```{r voyage activity trawl maps, echo=F, warning=F, include=FALSE}
# count positions in each lat lon bin
trawl_raster <- 
  # filter out low speeds while vessel in port 
  filter(fishing_data, gear %in% c('trawlers', 'fishing')) %>%
    group_by(lat_bin, lon_bin) %>%
      summarise(
        hours = sum(hours),
        fishing_hours = sum(fishing_hours),
        vessels = n_distinct(ssvid)
      )

# set upper limit
up_lim <- 500 
#set plot center 
new_center <- 17

# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=17 +wktext"

# set plot limits bound on the data
bounding_wa <- transform_box(xlim = c(-20, -13),
                          ylim = c(20, 7.5),
                          output_crs = best_proj)

# # # Specify custom x-axis breaks and labels
# custom_breaks <- c(150, 170, -170)
# custom_labels <- c("150° E", "170° E","170° W")

trawl_full <- trawl_raster %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'fishing_hours',
                  center = new_center) %>% 
  ggplot()+
  geom_gfw_outline(center = new_center, theme = "dark") +
  geom_raster(aes(x= lon_bin, y=lat_bin, fill = fishing_hours)) +
    geom_gfw_eez(theme = 'dark', alpha = 0.9, center = new_center) +
    geom_gfw_land(theme = 'dark', center = new_center) +
    # geom_sf(pipa, fill=NA, colour='green')+
    scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                      # limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +   
    coord_sf(xlim = c(bounding_wa$box_out[['xmin']], bounding_wa$box_out[['xmax']]),
      ylim = c(bounding_wa$box_out[['ymin']], bounding_wa$box_out[['ymax']]),
      crs = bounding_wa$out_crs) +
    # scale_x_continuous(breaks = custom_breaks, labels = custom_labels)+
    labs(fill = 'Fishing Hours') +
    theme_gfw_map(theme = 'light') 


fishwatchr::add_little_globe(trawl_full,
                             main_box = bounding_wa,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperright')

ggsave(filename = here::here('outputs', 'figures', paste0(country,"_", month,"_", "trawl_map_",str_replace_all(Sys.Date(), '-','_'),".png")), 
       units = 'cm', 
       width = 20, 
       height = 20,
       bg = '#f7f7f7')

```

```{r voyage activity purse seine maps, echo=F, warning=F, include=FALSE}
# count positions in each lat lon bin
ps_raster <- 
  # filter out low speeds while vessel in port 
  filter(fishing_data, gear %in% c('tuna_purse_seines')) %>%
    group_by(lat_bin, lon_bin) %>%
      summarise(
        hours = sum(hours),
        fishing_hours = sum(fishing_hours),
        vessels = n_distinct(ssvid)
      )

#set plot center 
new_center <- 40

# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=40 +wktext"

# set plot limits bound on the data
bounding_ps <- transform_box(xlim = c(-40, -13),
                          ylim = c(25, 7.5),
                          output_crs = best_proj)

ps_full <- ps_raster %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'fishing_hours',
                  center = new_center) %>% 
  ggplot()+
  geom_gfw_outline(center = new_center, theme = "dark") +
  geom_raster(aes(x= lon_bin, y=lat_bin, fill = fishing_hours)) +
    geom_gfw_eez(theme = 'dark', alpha = 0.9, center = new_center) +
    geom_gfw_land(theme = 'dark', center = new_center) +
    # geom_sf(pipa, fill=NA, colour='green')+
    scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                      # limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +   
    coord_sf(xlim = c(bounding_ps$box_out[['xmin']], bounding_ps$box_out[['xmax']]),
      ylim = c(bounding_ps$box_out[['ymin']], bounding_ps$box_out[['ymax']]),
      crs = bounding_ps$out_crs) +
    labs(fill = 'Fishing Hours')  +
    theme_gfw_map(theme = 'light') 


fishwatchr::add_little_globe(ps_full,
                             main_box = bounding_ps,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperright')

ggsave(filename = here::here('outputs', 'figures', paste0(country,"_", month,"_", "ps_map_",str_replace_all(Sys.Date(), '-','_'),".png")), 
       units = 'cm', 
       width = 20, 
       height = 20,
       bg = '#f7f7f7')

```
